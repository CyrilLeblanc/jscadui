var we=`:host {\r
  display: inline-block;\r
  --cube-size: 100px;\r
  --cube-line-color: #fff;\r
  --cube-z-color: var(--cube-line-color);\r
  --cube-x-color: var(--cube-line-color);\r
  --cube-y-color: var(--cube-line-color);\r
  --cube-bg: #ccc;\r
  --cube-fg: #444;\r
  --cube-bg-hover: #eee9;\r
  --cube-fg-hover: #444;\r
  --cube-corner-radius: 5px;\r
\r
  width: var(--cube-size);\r
  height: var(--cube-size);\r
  margin: calc( var(--cube-size) / 4 );\r
  perspective: 400px;\r
  --cube-transform: scale3d(0.8,0.8,0.8);\r
  --cube-transform-common: translateZ(calc( var(--cube-size) / 2 ));\r
}\r
*{\r
  box-sizing: border-box;\r
}\r
.cube, .cube__face, .cube__face i {\r
  user-select: none;\r
}\r
.cube {\r
  font-family: Verdana, Geneva, Tahoma, sans-serif;\r
  width: var(--cube-size);\r
  height: var(--cube-size);\r
  position: relative;\r
  transform-style: preserve-3d;\r
  transform: var(--cube-transform);\r
}\r
\r
.cube__face {\r
  position: absolute;\r
  width: var(--cube-size);\r
  height: var(--cube-size);\r
  font-size: calc( var(--cube-size) / 7 );\r
  text-align: center;\r
  display: grid;\r
  grid-template-columns: 20% 60% 20%;\r
  grid-template-rows: 20% 60% 20%;\r
  color: var(--cube-fg);\r
}\r
/*\r
  cube background element is intentionally added so we can put border and generate lines on the cube edges\r
  and at the same time allow the clickable elements to be responsive to mouse on top of those lines.\r
  At first border was on the cube__face directly, but then mouseover was flickering as the clickable elements were inside the border.\r
*/\r
.cube__face .bg {\r
  position: absolute;\r
  top: 0; left: 0;\r
  width: 100%; height: 100%;\r
  border: solid 1px var(--cube-line-color);\r
  background-color: var(--cube-bg);\r
  border-radius: var(--cube-corner-radius);\r
}\r
\r
.cube__face i{\r
  z-index: 1;\r
  font-style: normal;\r
  display: flex;\r
  align-items: center;\r
  justify-content: center;\r
}\r
.cube__face i[c]{\r
  cursor: pointer;\r
}\r
.cube__face i.hover{\r
  background-color: var(--cube-bg-hover);\r
  color: var(--cube-fg-hover);\r
}\r
\r
.cube__face--T   { transform: rotateY(  0deg) var(--cube-transform-common);}\r
.cube__face--B   { transform: rotateY(180deg) var(--cube-transform-common) rotateZ(180deg);}\r
.cube__face--E   { transform: rotateY( 90deg) var(--cube-transform-common) rotateZ(-90deg);}\r
.cube__face--W   { transform: rotateY(-90deg) var(--cube-transform-common) rotateZ(90deg);}\r
.cube__face--N   { transform: rotateX( 90deg) var(--cube-transform-common) rotateZ(180deg);}\r
.cube__face--S   { transform: rotateX(-90deg) var(--cube-transform-common);}\r
\r
\r
\r
.cube__face--T .bg   { border-left-color: var(--cube-y-color); border-bottom-color: var(--cube-x-color);}\r
.cube__face--B .bg   { border-left-color: var(--cube-y-color); border-top-color: var(--cube-x-color);}\r
/* .cube__face--E .bg   { } */\r
.cube__face--W .bg   { border-right-color: var(--cube-z-color); border-bottom-color: var(--cube-y-color); border-top-color: var(--cube-y-color);}\r
/* .cube__face--N .bg   { } */\r
.cube__face--S .bg   { border-left-color: var(--cube-z-color); border-bottom-color: var(--cube-x-color); border-top-color: var(--cube-x-color);}\r
\r
`;var Me={T:"TOP",B:"BOTTOM",S:"FRONT",N:"BACK",W:"LEFT",E:"RIGHT"},Y=(e,r,...t)=>{let n=[`<div part="face" class="cube__face cube__face--${r}"><div class="bg" part="face-bg"></div>`];return t.forEach(o=>o.split(",").forEach(l=>n.push(`<i c="${l}">${e[l]||""}</i>`))),n.push("</div>"),n.join("")},ee=class extends HTMLElement{constructor(t=Me){super();this.names=t}static{customElements.define("jscadui-gizmo",this)}static define(){}#e;#t;connectedCallback(){this.#e=this.attachShadow({mode:"open"}),this.#e.innerHTML=`<div class="cube"></div><style>${we}</style>`;let t=this.#t=this.#e.firstElementChild;this.setNames(this.names),t.addEventListener("click",o=>{let l=o.target.getAttribute("c");l&&this.oncam?.({cam:l})});let n=(o,l)=>{let h=o.getAttribute("c");h&&t.querySelectorAll(`[c="${h}"]`).forEach(b=>{l?b.classList.add("hover"):b.classList.remove("hover")})};t.addEventListener("pointerover",o=>n(o.target,!0)),t.addEventListener("pointerout",o=>n(o.target,!1)),t.addEventListener("dragstart",o=>o.preventDefault())}setNames(t=Me){this.#t.innerHTML=Y(t,"T","TNW,TN,TNE","TW,T,TE","TSW,TS,TSE")+Y(t,"B","BSW,BS,BSE","BW,B,BE","BNW,BN,BNE")+Y(t,"S","TSW,TS,TSE","SW,S,SE","BSW,BS,BSE")+Y(t,"N","TNE,TN,TNW","NE,N,NW","BNE,BN,BNW")+Y(t,"E","TSE,TE,TNE","SE,E,NE","BSE,BE,BNE")+Y(t,"W","TNW,TW,TSW","NW,W,SW","BNW,BW,BSW")}setSize(t){this.style.setProperty("--cube-size",t+"px")}rotateXZ(t,n){typeof t=="number"&&(t=t+"rad"),typeof n=="number"&&(n=n+"rad"),this.style.setProperty("--cube-transform",`scale3d(0.8,0.8,0.8) rotateX(${t}) rotateZ(${n})`)}};var ce=typeof Float32Array<"u"?Float32Array:Array;var Lt=Math.PI/180;Math.hypot||(Math.hypot=function(){for(var e=0,r=arguments.length;r--;)e+=arguments[r]*arguments[r];return Math.sqrt(e)});function ct(){var e=new ce(3);return ce!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function U(e,r,t){return e[0]=r[0]+t[0],e[1]=r[1]+t[1],e[2]=r[2]+t[2],e}function Te(e,r,t){return e[0]=r[0]-t[0],e[1]=r[1]-t[1],e[2]=r[2]-t[2],e}function te(e,r,t){var n=r[0],o=r[1],l=r[2],h=t[3]*n+t[7]*o+t[11]*l+t[15];return h=h||1,e[0]=(t[0]*n+t[4]*o+t[8]*l+t[12])/h,e[1]=(t[1]*n+t[5]*o+t[9]*l+t[13])/h,e[2]=(t[2]*n+t[6]*o+t[10]*l+t[14])/h,e}var Ot=function(){var e=ct();return function(r,t,n,o,l,h){var d,b;for(t||(t=3),n||(n=0),o?b=Math.min(o*t+n,r.length):b=r.length,d=n;d<b;d+=t)e[0]=r[d],e[1]=r[d+1],e[2]=r[d+2],l(e,e,h),r[d]=e[0],r[d+1]=e[1],r[d+2]=e[2];return r}}();var re=(e,r,t)=>e+(r-e)*t;var ne=(e,r)=>{var t=Math.sin(r),n=Math.cos(r),o=Math.sin(e),l=Math.cos(e);return[n,t,0,0,-t*l,n*l,o,0,-t*-o,n*-o,l,0,0,0,0,1]};var G=({target:e,len:r=1,rz:t=0,rx:n=0})=>{let o=te([],[0,0,r],ne(n,t));return e?U([],o,e):o};var{hypot:lt,acos:Ee}=Math,fe=(e,r,t)=>{let n=Te([],r,t),[o,l,h]=n,d=Math.hypot(o,l,h),b=lt(o,l),A=b==0?0:Ee(o/b),a=b==0?0:Ee(b/d);return h<0&&(a*=-1),l>0&&(A*=-1),e.target=t,e.position=r,e.rx=a,e.rz=A,e.len=d,e};var{PI:Ae}=Math,L=class{constructor({target:r,rx:t,rz:n,len:o,position:l},h=!1){this.target=r,this.rx=t,this.rz=n,this.len=Math.abs(o),h?this.position=l:l?fe(this,l,r):this.position=G(this)}set(r,t,n=!0){t&&(this.target=t),r&&(this.position=r),this.updateCalc(),n&&this.fireChange()}updateCalc(){fe(this,this.position,this.target)}calcAnim(r,t){let n=this.target,o=r.target,l=[];for(let h=0;h<3;h++)l[h]=re(n[h],o[h],t);return{rx:re(this.rx,r.rx,t),rz:re(this.rz,r.rz,t),target:l}}setRotate(r=0,t=0,n,o=!0){n&&(this.target=n),this.rx=r,this.rz=t,this.position=G(this),o&&this.fireChange()}rotateBy(r=0,t=0){this.rx+=r,this.rx<0&&(this.rx=1e-10),this.rx>Ae&&(this.rx=Ae),this.rz+=t,this.position=G(this),this.fireChange()}panBy(r,t){let{rx:n,rz:o}=this,l=[r,-t,0];l=te([],l,ne(n,o)),this.moveBy(l)}moveBy(r){this.position=U([],this.position,r),this.target=U([],this.target,r),this.fireChange()}zoomBy(r){this.len*=1+r,this.position=G(this),this.fireChange()}clone(){return new L(this,!0)}toJSON(){let{position:r,...t}=this;return t}fireInput(){this.oninput?.(this)}fireChange(){this.onchange?.(this),this.fireInput()}};var{PI:O}=Math,D=O/2,X=O*2,H=e=>{e=e.toUpperCase();let r=D,t=0,n,o,l;for(let h=0;h<e.length;h++){let d=e[h],b=ft(d);d==="T"||d==="B"?(r=b[0],l=d):n===void 0?n=b[1]:o=b[1]}if(n!==void 0)if(l&&(r=l==="T"?O/4:O*.75),o!==void 0){if(o<n){let h=o;o=n,n=h}n===0&&o>=O*1.5&&(o=-D),t=(n+o)/2}else t=n;return[r,t]},ft=e=>ze[e]||ze.top,ze={T:[1e-10,0],B:[O,0],S:[D,0],N:[D,O],W:[D,O*1.5],E:[D,D]};var{PI:Se}=Math,mt=e=>{for(;e<0;)e+=X;for(;e>X;)e-=X;return e},oe=(e,r)=>(e=mt(e),e-r>Se?e-X:r-e>Se?e+X:e);var{PI:Ce}=Math,ie=class extends L{constructor(t,{position:n,target:o=[0,0,0],rx:l=Ce/4,rz:h=Ce/4,len:d=200,panRatio:b=800,rxRatio:A=.01,rzRatio:a=.01,zoomRatio:x=.05}={}){super({position:n,target:o,rx:l,rz:h,len:d});this.animDuration=200;this.el=t,this.rxRatio=A,this.rzRatio=a;let u=!1,m=!1,s=!1,y=!1,i=!1,c=0,f=0,v=0,p={},T,M=()=>{let S=Object.keys(p),[g,w]=p[S[0]],[N,z]=p[S[1]],k=N-g,R=z-w;return{distance:Math.sqrt(k*k+R*R),midpoint:[(g+N)/2,(w+z)/2]}},C=S=>{S.addEventListener("pointerdown",g=>{c=g.button,f=g.clientX,v=g.clientY,u=!0,p[g.pointerId]=[g.clientX,g.clientY],Object.keys(p).length===2&&(m=!0)}),S.addEventListener("pointerup",g=>{u=!1,i&&S.releasePointerCapture(g.pointerId),i=!1,delete p[g.pointerId],Object.keys(p).length<2&&(m=!1,T=void 0)}),S.addEventListener("wheel",g=>{let w=Math.sign(g.deltaY);this.zoomBy(w*x)}),S.addEventListener("pointermove",g=>{if(!u)return;i||(S.setPointerCapture(g.pointerId),i=!0),s=c===1||c===0&&g.shiftKey,y=g.ctrlKey;let w=f-g.clientX,N=v-g.clientY;if(p[g.pointerId]=[g.clientX,g.clientY],s){let z=this.len/b;this.panBy(w*z,N*z)}else if(y)this.zoomBy((w+N)/200);else if(m){let z=M();if(T){let k=T.midpoint[0]-z.midpoint[0],R=T.midpoint[1]-z.midpoint[1],P=this.len/b;this.panBy(k*P,R*P);let V=z.distance/T.distance;this.zoomBy(1-V)}T=z}else this.rotateBy(N*this.rxRatio,w*this.rzRatio);f=g.clientX,v=g.clientY})};t instanceof Array?t.forEach(C):C(t)}doAnim(){let t=Math.min(1,(Date.now()-this.startTime)/this.animDuration),n=this.stateStart.calcAnim(this.stateEnd,t);ctrl.setRotate(n.rx,n.rz,n.target,!1),t<1?(this.animTimer=requestAnimationFrame(()=>this.doAnim()),this.fireInput()):this.stopAnim()}stopAnim(){cancelAnimationFrame(this.animTimer),this.animTimer=null,this.startTime=0,this.fireChange()}animateToCamera({target:t,rx:n,rz:o}){this.rz=oe(this.rz,o),this.startTime=Date.now(),this.stateStart=new L(ctrl,!0),this.stateEnd=new L({target:t||ctrl.target,rx:n,rz:o,len:ctrl.len}),this.animTimer=requestAnimationFrame(()=>this.doAnim())}animateToCommonCamera(t){let[n,o]=H(t);ctrl.animateToCamera({rx:n,rz:o,target:[0,0,0]})}setCommonCamera(t){this.setRotate(...H(t),[0,0,0])}};var ut=1,j=new Map,me="__RESPONSE__",ke=Symbol.for("__transferable__");var ue=e=>e?e.map(r=>r.buffer||r):[],ht=(e,r,{onJobCount:t,debug:n}={})=>{let o=e.postMessage?e:e.controller,l=(a,x)=>{n&&console.log(n,"sendResponse",x,a);let u=a?.[ke];u&&delete a[ke];try{o.postMessage({method:me,params:a,id:x},ue(u))}catch(m){throw console.error((n||"")+"failed to send ",a,u),m}},h=(a,x)=>{try{let u=a.stack;n&&console.log(n,"sendError",x,a),o.postMessage({method:me,error:{message:a.message,name:a.name,stack:u},id:x})}catch(u){throw console.error((n||"")+"failed to send ",u),u}},d=(a,x=[],u=[])=>{n&&console.log(n,"sendNotify",id,a,x),o.postMessage({method:a,params:x},ue(u))},b=(a,x=[],u=[],m)=>{let s=ut++;return n&&console.log(n,"sendCmd",s,a,x),o.postMessage({method:a,params:x,id:s},ue(u)),new Promise((i,c)=>{j.set(s,[i,c]),t?.(j.size),m&&setTimeout(()=>{c("timeout")},m)})},A=async a=>{let{method:x,params:u,id:m,error:s}=a.data;if(n&&console.log(n,"received",m,x,u,...s?["error:",s]:[]),m&&x===me){let i=j.get(m);if(!i)return console.error(`req ${m} not found`,m,a.data,a);j.delete(m),t?.(j.size);let[c,f]=i;if(s){let v=new Error(s.message);v.stack=s.stack,v.name=s.name,f(v)}else c(u);return}let y=r[x];if(!y){let i="no handler for type: "+x;throw console.error(i,a),new Error(i)}try{let i=await y(...u);m&&l(i,m)}catch(i){console.error(`error executing command ${x}`,u,i),h(i,m)}};return e.addEventListener?.("message",A),{sendCmd:b,sendNotify:d,sendResponse:l,sendError:h,listener:A,self:e,getRpcJobCount:()=>j.size}},Ne=(e,r,{onJobCount:t,debug:n}={})=>{let{sendCmd:o,sendNotify:l,getRpcJobCount:h,listener:d}=ht(e,r,{onJobCount:t,debug:n}),b=new Error("proxy");return new Proxy({getRpcJobCount:h,onmessage:d},{get(A,a,x){if(a in A||a==="then")return A[a];if(a.startsWith("on")&&(a.length==2||a[2]==a[2].toUpperCase()))return A[a]=function(...m){l(a,m)};let u=new Error("methodCreated");return A[a]=function(...m){try{return o(a,m)}catch(s){console.error("faild to call "+a,m,`
`,s,`
created`,b,`
methodCreated`,u)}}}})};var Re=({color1:e=[0,0,0,.2],color2:r=[0,0,.6,.1],size:t=200}={})=>{let n=t+1,o=Math.floor(n/10),l=new Float32Array(o*12+12),h=new Float32Array((n-o)*12),d=Math.floor(t/2);function b(u,m,s){return m=A(u,m,s,s,d,-d),m=A(u,m,-s,-s,d,-d),m=A(u,m,d,-d,s,s),m=A(u,m,d,-d,-s,-s),m}function A(u,m,s,y,i,c){return u[m++]=s,u[m++]=i,u[m++]=0,u[m++]=y,u[m++]=c,u[m++]=0,m}let a=0,x=0;a=A(l,a,0,0,d,-d),a=A(l,a,d,-d,0,0);for(let u=1;u<=d;u++)u%10==0?a=b(l,a,u):x=b(h,x,u);return[{vertices:l,color:e,type:"lines",isTransparent:!0},{vertices:h,color:r,type:"lines",isTransparent:!0}]};var _e=(e=100,r)=>{let t=Float32Array.of(0,0,0,e,0,0,0,0,0,0,e,0,0,0,0,0,0,e),n;return r?n=Float32Array.of(1,0,0,1,1,0,0,1,0,1,0,1,0,1,0,1,0,0,1,1,0,0,1,1):n=Float32Array.of(1,0,0,1,0,0,0,1,0,0,1,0,0,0,1,0,0,1),{vertices:t,colors:n,type:"lines"}};var Be={name:"Light",color:[0,.6,1,1],bg:[.95,.95,.95,1],grid1:[0,0,0,.2],grid2:[0,0,1,.1]};var dt='DIV[type="group"]',pt="INPUT, SELECT";var $e=(e,r,t)=>e.querySelectorAll(r).forEach(t),Le=(e,r)=>$e(e,pt,r),Pe=(e,r)=>$e(e,dt,r);var Ie={number:1,float:1,int:1,range:1,slider:1};function Oe(e){let r=e.previousElementSibling;r&&r.tagName==="I"&&(r.innerText=e.value)}var We=({params:e,target:r,callback:t,storedValues:n={},buttons:o=["reset","save","load","edit","link"]})=>{let l={},h={group:()=>"",choice:b,radio:d,checkbox:function({name:i,value:c}){return`<input type="checkbox" name="${i}" ${c==="checked"||c===!0?"checked":""}/>`}};function d({name:i,type:c,captions:f,value:v,values:p}){f||(f=p);let T='<div type="radio">';for(let M=0;M<p.length;M++){let C=v==p[M]||v==f[M]?"checked":"";T+=`<label><input type="radio" _type="${c}" name="${i}" numeric="${typeof p[0]=="number"?"1":"0"}" value="${p[M]}" ${C}/>${f[M]}</label>`}return T+"</div>"}function b({name:i,type:c,captions:f,value:v,values:p}){f||(f=p);let T=`<select _type="${c}" name="${i}" numeric="${typeof p[0]=="number"?"1":"0"}">`;for(let M=0;M<p.length;M++){let C=v==p[M]||v==f[M]?"selected":"";T+=`<option value="${p[M]}" ${C}>${f[M]}</option>`}return T+"</select>"}function A(i){let{name:c,type:f,value:v,min:p,max:T,step:M,placeholder:C,live:S}=i;v==null&&(v=Ie[f]?0:"");let g=f;(f=="int"||f=="float")&&(g="number"),(f=="range"||f=="slider")&&(g="range");let w=`<input _type="${f}" type="${g}" name="${c}"`;return M!==void 0&&(w+=` step="${M}"`),p!==void 0&&(w+=` min="${p}"`),T!==void 0&&(w+=` max="${T}"`),v!==void 0&&(w+=` value="${v}"`),w+=` live="${S?1:0}"`,C!==void 0&&(w+=` placeholder="${C}"`),w+"/>"}let a="",x=!1,u={};e.forEach(i=>{let{type:c,caption:f,name:v}=i;f||(f=v);let p=i.initial;if(i.default!==void 0&&(p=i.default),c=="checkbox"&&i.checked!==void 0&&(p=i.checked),i.value=l[v]=p,n[v]!==void 0&&(i.value=n[v]),c=="group"){let M=f[0];x=i.value=="closed",(M===">"||M==="+")&&(f=f.substring(1).trim(),x=!0)}i.closed=x,a+=`<div class="form-line" type="${i.type}" closed="${x?1:0}" `,c=="group"&&(a+=` name="${v}"`),a+='">',a+="<label",c=="group"&&(a+=` name="${v}"`),a+=`>${f}</label>`,a+=`<i>${i.value}</i>`;let T=h[c]||A;T&&(a+=T(i)),T||(u[c]=1),a+=`</div>
`});let m=Object.keys(u);m.length&&console.log("missing param impl",m);function s(i="change"){t(vt(r),i)}a+='<div class="jscad-param-buttons"><div>',o.forEach(i=>{let{id:c,name:f}=typeof i=="string"?{id:i,name:i}:i;a+=`<button action="${c}"><b>${f}</b></button>`}),a+="</div></div>",r.innerHTML=a,Le(r,i=>{let c=i.type;i.addEventListener("input",function(f){Oe(i),i.getAttribute("live")==="1"&&s("live")}),i.getAttribute("live")!=="1"&&i.addEventListener("change",()=>s("change"))});function y(i){let c=i.target;c.tagName==="LABEL"&&(c=c.parentNode);let f=c.getAttribute("closed")=="1"?"0":"1";do c.setAttribute("closed",f),c=c.nextElementSibling;while(c&&c.getAttribute("type")!="group");s("group")}Pe(r,i=>{i.onclick=y})},vt=e=>{let r={};return e&&(Pe(e,t=>{let n=t.getAttribute("name");r[n]=t.getAttribute("closed")=="1"?"closed":""}),Le(e,t=>{let n=t.name,o=t.value;t.tagName=="INPUT"&&(t.type=="checkbox"&&(o=t?.checked),t.type=="file"&&(o=t.files?.[0]),(t.type=="range"||t.type=="color")&&Oe(t)),(Ie[t.getAttribute("type")]||t.getAttribute("numeric")=="1"||o&&typeof o=="string"&&/^(\d+|\d+\.\d+)$/.test(o.trim()))&&(o=parseFloat(String(o||0))),!(t.type=="radio"&&!t.checked)&&(r[n]=o)})),r};function De({MeshPhongMaterial:e,LineBasicMaterial:r,BufferGeometry:t,BufferAttribute:n,Mesh:o,InstancedMesh:l,Line:h,LineSegments:d,Color:b,Vector3:A}){let x={mesh:{def:new e({color:34001,flatShading:!1}),make:s=>new e({flatShading:!1,...s})},line:{def:new r({color:255}),make:s=>new r(s)},lines:null};x.lines=x.line,x.instance=x.mesh;function u(s,{smooth:y=!1}){let{vertices:i,indices:c,normals:f,color:v,colors:p,isTransparent:T=!1,opacity:M}=s,{transforms:C}=s,S=s.type||"mesh",g=x[S];if(!g){console.error(`material not found for type ${S}`,s);return}let w=g.def,N=s.type==="instance";if((v||p)&&!N){let R=v||p,P={vertexColors:!!p,opacity:R[3]===void 0?1:R[3],transparent:v&&R[3]!==1&&R[3]!==void 0||T};M&&(P.opacity=M),p||(P.color=u.makeColor(v)),w=g.make(P),M&&(w.transparent=!0,w.opacity=M)}let z=new t;z.setAttribute("position",new n(i,3)),c&&z.setIndex(new n(c,1)),f&&z.setAttribute("normal",new n(f,3)),y&&(z=xt({Vector3:A,BufferAttribute:n},z,Math.PI/10)),p&&z.setAttribute("color",new n(p,T?4:3));let k;switch(S){case"mesh":k=new o(z,w);break;case"instance":let{list:R}=s;k=new l(z,x.mesh.make({color:34001}),R.length),R.forEach((P,V)=>{m(P.transforms,k.instanceMatrix.array,V*16)}),C=null;break;case"line":k=new h(z,w);break;case"lines":k=new d(z,w);break}return C&&!N&&k.applyMatrix4({elements:C}),k}function m(s,y=[],i=0){return y[i]=s[0],y[i+1]=s[1],y[i+2]=s[2],y[i+3]=s[3],y[i+4]=s[4],y[i+5]=s[5],y[i+6]=s[6],y[i+7]=s[7],y[i+8]=s[8],y[i+9]=s[9],y[i+10]=s[10],y[i+11]=s[11],y[i+12]=s[12],y[i+13]=s[13],y[i+14]=s[14],y[i+15]=s[15],y}return u.makeColor=s=>new b(s[0],s[1],s[2]),u.materials=x,u.setDefColor=s=>{x.mesh.def=new e({color:u.makeColor(s),flatShading:!1})},u}function xt({Vector3:e,BufferAttribute:r},t,n=Math.PI/3){let o=Math.cos(n),l=(1+1e-10)*100,h=[new e,new e,new e],d=new e,b=new e,A=new e,a=new e;function x(c){let f=~~(c.x*l),v=~~(c.y*l),p=~~(c.z*l);return`${f},${v},${p}`}let u=t.index?t.toNonIndexed():t,m=u.attributes.position,s={};for(let c=0,f=m.count/3;c<f;c++){let v=3*c,p=h[0].fromBufferAttribute(m,v+0),T=h[1].fromBufferAttribute(m,v+1),M=h[2].fromBufferAttribute(m,v+2);d.subVectors(M,T),b.subVectors(p,T);let C=new e().crossVectors(d,b).normalize();for(let S=0;S<3;S++){let g=h[S],w=x(g);w in s||(s[w]=[]),s[w].push(C)}}let y=new Float32Array(m.count*3),i=new r(y,3,!1);for(let c=0,f=m.count/3;c<f;c++){let v=3*c,p=h[0].fromBufferAttribute(m,v+0),T=h[1].fromBufferAttribute(m,v+1),M=h[2].fromBufferAttribute(m,v+2);d.subVectors(M,T),b.subVectors(p,T),A.crossVectors(d,b).normalize();for(let C=0;C<3;C++){let S=h[C],g=x(S),w=s[g];a.set(0,0,0);for(let N=0,z=w.length;N<z;N++){let k=w[N];A.dot(k)>o&&a.add(k)}a.normalize(),i.setXYZ(v+C,a.x,a.y,a.z)}}return u.setAttribute("normal",i),u}function Fe({PerspectiveCamera:e,AmbientLight:r,HemisphereLight:t,WebGLRenderer:n,DirectionalLight:o,Scene:l,Group:h,Vector3:d,Color:b,MeshPhongMaterial:A,LineBasicMaterial:a,BufferGeometry:x,BufferAttribute:u,Mesh:m,InstancedMesh:s,Line:y,LineSegments:i}){let c,f,v,p,T,C=Date.now(),S=!0,g,w=new b(1,1,1),N=[],z=[],k,R=De({MeshPhongMaterial:A,LineBasicMaterial:a,BufferGeometry:x,BufferAttribute:u,Mesh:m,InstancedMesh:s,Line:y,LineSegments:i,Color:b,Vector3:d}),P=({canvas:E,cameraPosition:_=[180,-180,220],cameraTarget:B=[0,0,0],bg:W=[1,1,1],lightPosition:$})=>{f=new e(45,1,1,5e4),f.up.set(0,0,1),f.position.set(..._),f.lookAt(...B),window.camera=f,window.updateView=F,c=new l,$=null;let q=new r(15658734,$?.2:.5);c.add(q);let Q=new t(15658717,3355443,.5);Q.position.set(0,0,2e3),$&&c.add(Q);let Z=new o(15658740,.7);Z.castShadow=!1,$?(Z.position.set(...$),c.add(Z)):(Z.position.set(50,0,100),f.add(Z),c.add(f)),be(W),p=new n({antialias:!0,preserveDrawingBuffer:!0,canvas:E}),p.setPixelRatio(window.devicePixelRatio)},V=typeof requestAnimationFrame>"u"?setTimeout:requestAnimationFrame;function F(E=8){g||!p||(g=V(Qe,E))}function be(E=[1,1,1]){c.background=new b(...E),F()}function Rt(E){T=E}function Ke(E=[1,1,1]){w=new b(...E),R.setDefColor(E),F()}function Qe(){g=null,v?.update(),p.render(c,f),p.autoClear=!1,p.autoClear=!0}function et({width:E,height:_}){f.aspect=E/_,f.updateProjectionMatrix(),p.setSize(E,_),F()}let tt={setScene:ye};function rt(E){let _=tt[E.action];if(!_)throw new Error("no handler for type: "+E.action);_(E)}function nt(E){rt(E)}function ot({position:E,target:_}){E&&f.position.set(...E),_&&f.lookAt(..._),F()}function it(){let E=new d(0,0,-1);return E.applyQuaternion(f.quaternion),{position:f.position.toArray(),target:E.toArray()}}return function(_,{camera:B={},bg:W}={}){k=document.createElement("CANVAS"),_.appendChild(k);let $=()=>{_.removeChild(k)};try{P({canvas:k,bg:W,cameraPosition:B.position,cameraTarget:B.target})}catch(Q){throw $(),Q}return{sendCmd:nt,resize:et,destroy:$,getCamera:it,setCamera:ot,camera:B,setBg:be,setMeshColor:Ke,setScene:ye,getViewerEnv:()=>({forceColors4:!1,forceIndex:!1,forceNormals:!1,useInstances:!1})}};function ye(E,{smooth:_}={}){z.forEach(B=>{c.remove(B)}),N.forEach(B=>{B.geometry&&B.geometry.dispose()}),N.length=0,E.items.forEach(B=>{let W=new h;z.push(W),B.items.forEach($=>{let q=R($,{smooth:_,scene:E,meshColor:w});q?(N.push(q),W.add(q)):console.error("could not convert to obj3d",$)}),c.add(W)}),F()}}var qe=(e,r)=>{new ResizeObserver(n=>{r(n[0])}).observe(e)};var Ye=(e,r)=>{let n=Fe(e)(r);return qe(r,o=>n.resize(o.contentRect)),n};var gt=Be,he,je,bt=_e(50),Ve=[],K,ae=e=>e?.nodeType!==void 0?e:document.getElementById(e),de=window.gizmo=new ee;ae("layout").appendChild(de);function Ze(e){let r=[...e,...je,bt];K.setScene({items:[{id:"model",items:r}]}),Ve=e}function yt(e){K.setMeshColor(e.color),K.setBg(e.bg),je=Re({size:200,color1:e.grid1,color2:e.grid2}),Ze(Ve)}var Xe=localStorage.getItem("camera.location"),Ue={position:[180,-180,220]};try{Xe&&(Ue=JSON.parse(Xe))}catch(e){console.log(e)}var wt=[ae("root")],I=window.ctrl=new ie(wt,{...Ue,alwaysRotate:!1});function Mt({position:e,target:r,rx:t,rz:n}){K.setCamera({position:e,target:r}),de.rotateXZ(t,n)}var pe=e=>{let{position:r,target:t,rx:n,rz:o,len:l,...h}=e;Mt(e)},Ge=e=>localStorage.setItem("camera.location",JSON.stringify(e));I.onchange=e=>{Ge(e),Et(),pe(e)};de.oncam=({cam:e})=>{let[r,t]=H(e);Tt({rx:r,rz:t,target:[0,0,0]}),Ge(ve)};var Tt=({target:e,rx:r,rz:t})=>{xe=Date.now(),I.rz=oe(I.rz,t),Je=new L(I,!0),ve=new L({target:e||I.target,rx:r,rz:t,len:I.len}),se=requestAnimationFrame(He)},Et=()=>{cancelAnimationFrame(se),se=null,xe=0},He=()=>{let e=Math.min(1,(Date.now()-xe)/At),r=Je.calcAnim(ve,e);I.setRotate(r.rx,r.rz,r.target,!1),pe(I),e<1&&(se=requestAnimationFrame(He))},At=200,se,Je,ve,xe,zt={entities:({entities:e})=>{e instanceof Array||(e=[e]),Ze(e)}},J=document.createElement("a");J.style.display="none";document.body.appendChild(J);function St(e,r){J.href=URL.createObjectURL(e),J.download=r,J.click()}function Ct(e){sendCmd("jscadExportData",[{format:e}]).then(({data:r})=>{console.log("save",he+".stl",r),St(new Blob([r],{type:"text/plain"}),he+".stl")})}window.exportModel=Ct;var kt=new Worker("./build/bundle.worker.js"),ge=globalThis.workerApi=Ne(kt,zt,{}),Nt=e=>{console.log("params",e),ge.jscadMain({params:e})},wr=e=>{he=e.replace(/.*\//,"").replace(/\..*/,""),ge.jscadScript({url:e}).then(r=>{console.log("result",r),We({target:ae("paramsDiv"),params:r.def||{},callback:Nt})})},Mr=async(e,r,t)=>{K=Ye(e,ae(r)),pe(I),yt(gt),await ge.jscadInit(t)};export{ae as byId,Mr as initEngine,wr as jscadScript};
//# sourceMappingURL=main.js.map
